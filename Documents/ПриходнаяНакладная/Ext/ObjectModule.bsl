Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	// Если данные загружаются из другой базы, то не выполняем пересчет
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	// Расчет суммы по документу как итог по колонке "Сумма" в табличной части "СписокНоменклатуры"
	СуммаПоДокументу = СписокНоменклатуры.Итог("Сумма");
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, Режим)
	// Если документ не проводится, то выходим
	Если НЕ Проведен Тогда
		Возврат;
	КонецЕсли;
	
	// Очищаем движения документа по регистру ОстаткиНоменклатуры
	Движения.ОстаткиНоменклатуры.Записывать = Истина;
	
	// Создаем временную таблицу для схлопывания (группировки) одинаковой номенклатуры
	СгруппированныеСтроки = Новый ТаблицаЗначений;
	СгруппированныеСтроки.Колонки.Добавить("Номенклатура");
	СгруппированныеСтроки.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число"));
	
	// Заполняем временную таблицу данными из табличной части
	Для Каждого СтрокаТЧ Из СписокНоменклатуры Цикл
		// Ищем строку с такой же номенклатурой в сгруппированной таблице
		СтрокаПоиска = СгруппированныеСтроки.Найти(СтрокаТЧ.Номенклатура, "Номенклатура");
		
		// Если строка с такой номенклатурой уже есть, то добавляем количество
		Если СтрокаПоиска <> Неопределено Тогда
			СтрокаПоиска.Количество = СтрокаПоиска.Количество + СтрокаТЧ.Количество;
			// Иначе добавляем новую строку
		Иначе
			НоваяСтрока = СгруппированныеСтроки.Добавить();
			НоваяСтрока.Номенклатура = СтрокаТЧ.Номенклатура;
			НоваяСтрока.Количество = СтрокаТЧ.Количество;
		КонецЕсли;
	КонецЦикла;
	
	// Формируем движения по регистру ОстаткиНоменклатуры на основе сгруппированных данных
	Для Каждого СгруппированнаяСтрока Из СгруппированныеСтроки Цикл
		// Создаем движение типа "Приход"
		Движение = Движения.ОстаткиНоменклатуры.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = Дата;
		Движение.Номенклатура = СгруппированнаяСтрока.Номенклатура;
		Движение.Склад = Склад;
		Движение.Количество = СгруппированнаяСтрока.Количество;
	КонецЦикла;
	
КонецПроцедуры